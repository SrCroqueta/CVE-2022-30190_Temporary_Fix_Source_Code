# This script is made for automate the process of a temporary fix for the vuln CVE-2022-30190.
# Created and compile by @SrCroqueta_ .

# Yes, it could be baked better, but this has been designed for fast implement and with not
# much knowledge of programming, so sorry if it looks really nasty hehe :P.

import os, time, ctypes

key_name = 'ms-msdt_backup.reg'
directory_registry_key = 'HKEY_CLASSES_ROOT\ms-msdt'
registry_key_created_on = 'HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\ScriptedDiagnostics'
name_new_key = 'EnableDiagnostics'

def cls():
    os.system('cls||clear')

def isAdmin():
    try:
        is_admin = (os.getuid() == 0)
    except AttributeError:
        is_admin = ctypes.windll.shell32.IsUserAnAdmin() != 0
    return is_admin

def import_registry_key():
    print('/'*34 + ' TEMPORARY FIX FOR CVE-2022-30190 ' + '/'*34)
    print('='*102)
    print(f'\nImporting registry key {key_name} . . .')
    print('-'*102)

    time.sleep(2.5)

    os.system('cmd /c "reg import ms-msdt_backup.reg"')

    print(f'Registry key "{key_name}" has been imported. The file will be removed safely.\n')
    print('='*102+'\n'+'/'*102)

def delete_backup_key():
    print('='*102)
    print(f'\nDeleting registry key file "{key_name}" . . .')
    print('-'*102)

    time.sleep(2.5)

    os.remove(key_name)

    print(f'Registry key file has been removed.\n')
    print('='*102+'\n'+'/'*102)

def delete_gpo():
    print('='*102)
    print(f'\nDeleting registry key on "{registry_key_created_on}"\nto enable Windows Troubleshooter again . . .')
    print('-'*102)

    time.sleep(2.5)

    os.system('cmd /c "reg delete HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\ScriptedDiagnostics /f"')

    print(f'Registry key for Windows Troubleshooter has been deleted. Now it is working again.\n')
    print('='*102)
    print('/'*102)

def main():
    cls()

    if isAdmin():
        import_registry_key()
        delete_backup_key()
        delete_gpo()

        input('\n                                    Press "Enter" to continue . . .')
        cls()

        print('/'*102)
        print('                                  All the changes has been reverted.')
        print('/'*102)
        input('\n                                    Press "Enter" to continue . . .')
        cls()
    else:
        print('/'*102)
        print('                              -- You must run this as Administrator. --')
        print('/'*102)
        input('\n                                    Press "Enter" to continue . . .')
        cls()

if __name__ == "__main__":
    main()